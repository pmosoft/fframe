<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="net.pmosoft.fframe.dams.table.TabDao">


<!--******************************************************** 
**
**                      MetaTablCol
**
*********************************************************-->
 
<delete id="deleteMetaTabCol" parameterType="java.util.HashMap">
    -- TableDao.deleteMetaTabCol
    DELETE FROM TDACM00081
</delete>

<insert id="insertMetaTabColList" parameterType="java.util.HashMap">
    -- TableDao.insertMetaTabCol
    INSERT INTO TDACM00081 
    SELECT 
           'MARIADB'              AS DB_NM
           ,UPPER(A.TABLE_SCHEMA) AS OWNER
           ,UPPER(A.TABLE_NAME)   AS TAB_NM
           ,A.ORDINAL_POSITION    AS COL_ID
           ,A.COLUMN_NAME         AS COL_NM
           ,A.COLUMN_COMMENT      AS COL_HNM
           ,' '                   AS COL_DESC
           ,UPPER(A.DATA_TYPE)    AS DATA_TYPE_NM
           ,CASE WHEN UPPER(A.DATA_TYPE) IN ('CHAR','VARCHAR') THEN A.CHARACTER_MAXIMUM_LENGTH
                 WHEN UPPER(A.DATA_TYPE) IN ('INT','NUMERIC') THEN A.NUMERIC_PRECISION
            END                   AS LEN
           ,A.NUMERIC_SCALE       AS DECIMAL_CNT 
           ,CASE WHEN UPPER(A.DATA_TYPE) = 'INT' THEN UPPER(A.DATA_TYPE)
                 ELSE UPPER(A.COLUMN_TYPE)
            END                   AS DATA_TYPE_DESC
           ,DATE_FORMAT(NOW(),'%Y%m%d%H%i') AS REG_DTM
           ,''                    AS REG_USR_ID
           ,DATE_FORMAT(NOW(),'%Y%m%d%H%i') AS UPD_DTM
           ,''                    AS UPD_USR_ID
    FROM   INFORMATION_SCHEMA.COLUMNS A 
    WHERE  1=1
    AND    TABLE_NAME LIKE 'TD%'
    AND    COLUMN_NAME LIKE '%'
    ORDER BY A.TABLE_NAME,A.ORDINAL_POSITION    
</insert>

<insert id="insertMetaTab" parameterType="java.util.HashMap">
    -- TableDao.insertMetaTab
    INSERT INTO TDACM00070 
    SELECT 
           'MARIADB'               AS DB_NM
           ,UPPER(A.TABLE_SCHEMA)  AS OWNER
           ,UPPER(A.TABLE_NAME)    AS TAB_NM
           ,UPPER(A.TABLE_COMMENT) AS TAB_HNM
           ,''                     AS TAB_DESC
           ,DATE_FORMAT(NOW(),'%Y%m%d%H%i') AS REG_DTM
           ,''                    AS REG_USR_ID
           ,DATE_FORMAT(NOW(),'%Y%m%d%H%i') AS UPD_DTM
           ,''                    AS UPD_USR_ID
    FROM   INFORMATION_SCHEMA.TABLES A 
    WHERE  1=1
    AND    TABLE_NAME LIKE 'TD%'
    ORDER BY A.TABLE_SCHEMA, A.TABLE_NAME    
</insert>



<select id="selectMetaTabColList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
    -- TableDao.selectMetaTabColList
    SELECT  '추출'               AS STS_NM
           ,A.*
    FROM TDACM00081 A 
    ORDER BY A.TAB_NM,A.COL_ID    
</select>

<select id="selectCmpTabColList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
    -- TableDao.selectCmpTabColList
    SELECT '신규' AS STS_NM,A.*
    FROM   TDACM00081 A
           LEFT OUTER JOIN TDACM00080 B
           ON   A.DB_NM = B.DB_NM
           AND  A.OWNER = B.OWNER
           AND  A.TAB_NM = B.TAB_NM
           AND  A.COL_NM = B.COL_NM
           AND  A.DATA_TYPE_DESC = B.DATA_TYPE_DESC
    WHERE  B.COL_NM IS NULL           
    ORDER BY A.TAB_NM,A.COL_ID    
</select>


<insert id="insertCmpTabColList" parameterType="java.util.HashMap">
    -- TableDao.insertMetaTabCol
    INSERT INTO TDACM00080 
    SELECT A.*
    FROM   TDACM00081 A
           LEFT OUTER JOIN TDACM00080 B
           ON   A.DB_NM = B.DB_NM
           AND  A.OWNER = B.OWNER
           AND  A.TAB_NM = B.TAB_NM
           AND  A.COL_NM = B.COL_NM
           AND  A.COL_HNM = B.COL_HNM
           AND  A.DATA_TYPE_DESC = B.DATA_TYPE_DESC
    WHERE  B.COL_NM IS NULL           
    ORDER BY A.TAB_NM,A.COL_ID    
</insert>


 
<!--******************************************************** 
**
**                        TablCol
**
*********************************************************-->

<select id="selectTabColList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
    -- TableDao.selectTabColList
    SELECT   A.DB_NM
            ,A.OWNER
            ,A.TAB_NM
            ,B.TAB_HNM
            ,A.COL_ID
            ,A.COL_NM
            ,A.COL_HNM
            ,TRIM(A.COL_DESC) AS COL_DESC
            ,A.DATA_TYPE_NM
            ,A.LEN
            ,A.DECIMAL_CNT
            ,A.DATA_TYPE_DESC
            ,DATE_FORMAT(A.REG_DTM,'%Y.%m.%d %H:%i:%S') AS REG_DTM
            ,A.REG_USR_ID
            ,DATE_FORMAT(A.UPD_DTM,'%Y.%m.%d %H:%i:%S') AS UPD_DTM
            ,A.UPD_USR_ID
    FROM    TDACM00080 A 
            LEFT JOIN TDACM00070 B
            ON  A.DB_NM = B.DB_NM
            AND A.OWNER = B.OWNER
            AND A.TAB_NM = B.TAB_NM
    WHERE   1=1
    AND  (
          (#{searchKeyCombo} = 'DB_NM'        AND A.DB_NM        LIKE CONCAT(CONCAT('%',#{searchValue}),'%'))
           OR   
          (#{searchKeyCombo} = 'OWNER'        AND A.OWNER        LIKE CONCAT(CONCAT('%',#{searchValue}),'%'))
           OR   
          (#{searchKeyCombo} = 'TAB_NM'       AND A.TAB_NM       LIKE CONCAT(CONCAT('%',#{searchValue}),'%'))
           OR   
          (#{searchKeyCombo} = 'TAB_HNM'      AND B.TAB_HNM      LIKE CONCAT(CONCAT('%',#{searchValue}),'%'))
           OR   
          (#{searchKeyCombo} = 'COL_NM'       AND A.COL_NM       LIKE CONCAT(CONCAT('%',#{searchValue}),'%'))
           OR   
          (#{searchKeyCombo} = 'COL_HNM'      AND A.COL_HNM      LIKE CONCAT(CONCAT('%',#{searchValue}),'%'))
           OR   
          (#{searchKeyCombo} = 'DATA_TYPE_NM' AND A.DATA_TYPE_NM LIKE CONCAT(CONCAT('%',#{searchValue}),'%'))
         ) 
    ORDER BY A.DB_NM,OWNER,A.TAB_NM,A.COL_ID
</select>
 
<select id="selectTabColCnt" parameterType="java.util.HashMap" resultType="int">
    -- TableDao.selectTabColCnt
    SELECT COUNT(*) CNT
    FROM   TDACM00010
    WHERE  PKG_FUL_NM = #{PKG_FUL_NM}
</select>

<insert id="insertTabCol" parameterType="java.util.HashMap">

    -- TableDao.insertTabCol
    INSERT INTO TDACM00010
    (
         PKG_FUL_NM
        ,PKG2_NM
        ,PKG3_NM
        ,PKG4_NM
        ,PKG_HNM
        ,PKG_DESC
        ,USE_YN
        ,REG_DTM
        ,REG_USR_ID
        ,UPD_DTM
        ,UPD_USR_ID
    ) VALUES (
         #{PKG_FUL_NM}
        ,#{PKG2_NM}
        ,#{PKG3_NM}
        ,#{PKG4_NM}
        ,#{PKG_HNM}
        ,#{PKG_DESC}
        ,CASE WHEN #{USE_YN} = 'true' THEN 'Y' ELSE 'N' END
        ,curdate()
        ,#{REG_USR_ID}
        ,curdate()
        ,#{UPD_USR_ID}
    )

</insert>

<delete id="deleteTabCol" parameterType="java.util.HashMap">
    -- TableDao.deleteTabCol
    DELETE FROM TDACM00080
</delete>

<delete id="deleteTab" parameterType="java.util.HashMap">
    -- TableDao.deleteTab
    DELETE FROM TDACM00070
</delete>


<update id="updateTabCol" parameterType="java.util.HashMap">

    -- TableDao.updateTabCol
    UPDATE TDACM00010
    SET  PKG2_NM      = #{PKG2_NM}
        ,PKG3_NM      = #{PKG3_NM}
        ,PKG4_NM      = #{PKG4_NM}
        ,PKG_HNM      = #{PKG_HNM}
        ,PKG_DESC     = #{PKG_DESC}
        ,USE_YN       = CASE WHEN #{USE_YN} = 'true' THEN 'Y' ELSE 'N' END
        ,UPD_DTM      = curdate()
        ,UPD_USR_ID  = #{UPD_USR_ID}
    WHERE  PKG_FUL_NM = #{PKG_FUL_NM}

</update>


<!-- 

                              Table

 -->

<select id="selectTabList" parameterType="java.util.HashMap" resultType="java.util.HashMap">

	-- TableDao.selectTabList
	SELECT   PKG_FUL_NM
			,PKG2_NM
			,PKG3_NM
			,PKG4_NM
			,PKG_HNM
			,PKG_DESC
			,USE_YN
			,date_format(REG_DTM,'%Y.%m.%d %H:%i:%S') AS REG_DTM
			,REG_USR_ID
			,date_format(UPD_DTM,'%Y.%m.%d %H:%i:%S') AS UPD_DTM
			,UPD_USR_ID
	FROM    TDACM00010
    WHERE   PKG2_NM LIKE CONCAT(CONCAT('%',#{searchValue}),'%')
    OR      PKG3_NM LIKE CONCAT(CONCAT('%',#{searchValue}),'%')
    OR      PKG4_NM LIKE CONCAT(CONCAT('%',#{searchValue}),'%')
    OR      PKG_FUL_NM LIKE CONCAT(CONCAT('%',#{searchValue}),'%')
    OR      PKG_HNM LIKE CONCAT(CONCAT('%',#{searchValue}),'%')
    OR      PKG_DESC LIKE CONCAT(CONCAT('%',#{searchValue}),'%')
	ORDER BY PKG_FUL_NM
</select>

<select id="selectTabCnt" parameterType="java.util.HashMap" resultType="int">
	-- TableDao.selectTabCnt
	SELECT COUNT(*) CNT
	FROM   TDACM00010
    WHERE  PKG_FUL_NM = #{PKG_FUL_NM}
</select>

<insert id="insertTab" parameterType="java.util.HashMap">

	-- TableDao.insertTab
	INSERT INTO TDACM00010
	(
	     PKG_FUL_NM
		,PKG2_NM
		,PKG3_NM
		,PKG4_NM
		,PKG_HNM
		,PKG_DESC
		,USE_YN
		,REG_DTM
		,REG_USR_ID
		,UPD_DTM
		,UPD_USR_ID
	) VALUES (
         #{PKG_FUL_NM}
		,#{PKG2_NM}
		,#{PKG3_NM}
		,#{PKG4_NM}
		,#{PKG_HNM}
		,#{PKG_DESC}
		,CASE WHEN #{USE_YN} = 'true' THEN 'Y' ELSE 'N' END
		,curdate()
		,#{REG_USR_ID}
		,curdate()
		,#{UPD_USR_ID}
	)

</insert>

<update id="updateTab" parameterType="java.util.HashMap">

	-- TableDao.updateTab
	UPDATE TDACM00010
	SET  PKG2_NM      = #{PKG2_NM}
		,PKG3_NM      = #{PKG3_NM}
		,PKG4_NM      = #{PKG4_NM}
		,PKG_HNM      = #{PKG_HNM}
		,PKG_DESC     = #{PKG_DESC}
		,USE_YN       = CASE WHEN #{USE_YN} = 'true' THEN 'Y' ELSE 'N' END
		,UPD_DTM      = curdate()
		,UPD_USR_ID  = #{UPD_USR_ID}
	WHERE  PKG_FUL_NM = #{PKG_FUL_NM}

</update>


</mapper>
